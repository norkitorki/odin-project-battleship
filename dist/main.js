(()=>{"use strict";const e=(e="",t={},a=!1)=>{const r={name:e,gameboard:t,computerPlayer:a,attack:(e,a,r)=>t.makeAttack(a,r,e.gameboard),randomShipPlacement:e=>{const a=(e=>{const a=Math.floor(Math.random()*t.rows),r=Math.floor(Math.random()*t.columns),o=Math.floor(100*Math.random()),n=[];for(let t=0;t<e;t++)n.push(o<50?[a+t,r]:[a,r+t]);return n})(e.length);try{return t.placeShip(a,e),a}catch(t){return r.randomShipPlacement(e)}}};if(a){let e,a,o;r.reset=()=>{e={},a=[],o=[];for(let e=0;e<t.rows;e++)for(let a=0;a<t.columns;a++)o.push([e,a])},r.reset();const n=e=>Math.floor(Math.random()*e.length),l=r=>{const[o,n]=r;return o>=0&&o<t.rows&&n>=0&&n<t.columns&&!e[r]&&!a.some((e=>e[0]===o&&e[1]===n))},c=e=>{const[t,r]=e;[[t+1,r],[t-1,r],[t,r+1],[t,r-1]].forEach((e=>{if(l(e)){a.push(e);const t=o.findIndex((t=>t[0]===e[0]&&t[1]===e[1]));o.splice(t,1)}}))};r.attack=r=>{const l=a.length>0?a:o;if(0===l.length)return null;const s=n(l),i=l[s];l.splice(s,1);const[d,h]=i,m=t.makeAttack(d,h,r.gameboard);return e[i]=!0,m&&c(i),{coordinates:i,attackResult:m}}}return r},t=(e=10,t=10)=>{let a=0,r={};const o={rows:e,columns:t},n=()=>{a=0,r={},o.targetBoard={},o.fleetBoard={},o.shipPlacements=[],o.shipCount=0,o.hitCount=0,o.missCount=0};n();const l=(a,r)=>a>=0&&a<e&&r>=0&&r<t,c=(e,t,a={horizontal,vertical})=>{e.sort();let[r,o]=e[t-1],[n,l]=e[t],c=n===r&&(o+1===l||o-1===l),s=l===o&&(r+1===n||r-1===n);return a.horizontal||a.vertical?!!(a.horizontal&&c||a.vertical&&s)&&a:(a.horizontal=c,a.vertical=s,!(!a.horizontal&&!a.vertical)&&a)};return o.placeShip=(e=[],t={})=>(((e,t)=>{if(0===t.length)throw new Error("Coordinates cannot be empty");let a,r,o;t.forEach(((n,s)=>{if(s>0){if(a=c(t,s,{horizontal:r,vertical:o}),!a)throw new Error("Coordinates must be vertically or horizontally adjacent");r=a.horizontal,o=a.vertical}if(e[n])throw new Error("Ships cannot overlap each other");if(!l(n[0],n[1]))throw new Error("Coordinates are out of range")}))})(o.fleetBoard,e),r[++a]=t,o.shipPlacements.push(e),o.shipCount++,e.forEach((e=>o.fleetBoard[e]=a)),t),o.getShip=(e,t)=>r[o.fleetBoard[[e,t]]],o.receiveAttack=(e=0,t=0)=>{if(!l(e,t))return;const a=o.fleetBoard[[e,t]];if(a){const n=r[a];return n&&(n.hit(),o.hitCount++,n.isSunk()&&o.shipCount--),o.fleetBoard[[e,t]]=!0,n||!0}return void 0===a&&o.missCount++,o.fleetBoard[[e,t]]=!1},o.makeAttack=(e=0,t=0,a)=>{const r=a.receiveAttack(e,t);return o.targetBoard[[e,t]]=!!r,r},o.allShipsSunk=()=>0===o.shipCount,o.clear=()=>{n()},o},a=(e,t,a={keyboardTraverse:!0})=>{const r={locked:!1},o={},n=document.createElement("div");n.classList.value="gameboard",n.style.gridTemplate=`repeat(${e+1}, 1fr) / repeat(${t+1}, 1fr)`,a.keyboardTraverse&&n.addEventListener("keydown",(a=>{const r=a.code;if(r.startsWith("Arrow")||r.startsWith("Key")){const o=document.activeElement;if("BUTTON"===o.nodeName&&o.parentElement===n){a.preventDefault();let l=Number(o.dataset.field[0]),c=Number(o.dataset.field[1]);"ArrowUp"!==r&&"KeyW"!==r||l--,"ArrowDown"!==r&&"KeyS"!==r||l++,"ArrowLeft"!==r&&"KeyA"!==r||c--,"ArrowRight"!==r&&"KeyD"!==r||c++,l>=0&&l<e&&c>=0&&c<t&&n.querySelector(`[data-field="${l}${c}"]`).focus()}}}));const l=(e,t)=>{const a=document.createElement(e);t(a),n.appendChild(a)},c=e=>t=>t.textContent=e<1?"":e,s=e=>t=>t.textContent=String.fromCharCode(65+e%26),i=(e,t)=>a=>a.dataset.field=`${e}${t}`,d=(e,t)=>n.querySelector(`[data-field="${e}${t}"]`);for(let e=0;e<=t;e++)l("span",c(e));for(let a=0;a<e;a++){l("span",s(a));for(let e=0;e<t;e++)l("button",i(a,e))}return r.renderBoard=(e=document.body,t=!0)=>{const a=e.querySelector(".gameboard");a&&t&&a.remove(),e.appendChild(n)},r.addCallback=(e,t,a)=>{o[e]||(o[e]={}),o[e][t]=e=>{const t=e.target;if(!r.locked&&"BUTTON"===t.nodeName){const[e,r]=t.dataset.field;a.call(null,Number(e),Number(r))}},n.addEventListener(e,o[e][t])},r.removeCallback=(e,t)=>{n.removeEventListener(e,o[e][t]),delete o[e][t]},r.updateField=(e,t,a,r="")=>{const o=d(e,t),n=document.getElementById(a);if(o&&n){const e=n.content.cloneNode(!0);Array.from(o.children).forEach((e=>o.removeChild(e))),o.setAttribute("class",r),o.appendChild(e)}},r.highlightField=(e,t)=>{const a=d(e,t);a&&a.classList.toggle("highlighted")},r.removeHighlights=()=>{n.querySelectorAll(".highlighted").forEach((e=>e.classList.remove("highlighted")))},r.clear=(e=!1)=>{n.querySelectorAll("button").forEach((e=>{Array.from(e.children).forEach((t=>e.removeChild(t))),e.setAttribute("class","")})),e&&Object.keys(o).forEach((e=>{Object.keys(o[e]).forEach((t=>{r.removeCallback(e,t)}))}))},r},r=e=>({length:e,hits:0,hit:function(){this.hits++},isSunk:function(){return this.hits>=this.length}}),o=e=>e===v?"#5cff5c":e===C?"#ffff63":"#ffffff",n=(e,t,a)=>{e.container.classList.remove("hidden"),e.container.classList.add("activePlayer"),t.container.classList.remove("activePlayer"),t.container.classList.add("hidden"),document.querySelector(".playerName").textContent=a||e.name,document.querySelector(".playerColor").style.backgroundColor=o(e)},l=()=>{k.querySelectorAll(".playerContainer").forEach((e=>{e.classList.remove("winningPlayer"),e.remove()})),k.appendChild(E.player.container),k.appendChild(E.opponent.container),n(E.player,E.opponent),d(!1),E.resetGame().then((()=>E.playGame()))},c=e=>{if(!E.gameInProgress){E.shipPlacementDirection=e;const t=y.querySelector("#horizontalPlacement"),a=y.querySelector("#verticalPlacement");"h"===e?(t.classList.add("activeDirection"),a.classList.remove("activeDirection")):(a.classList.add("activeDirection"),t.classList.remove("activeDirection"))}},s=()=>{E.toggleComputer(),l()},i=(e,t,a)=>{!0===a||!1===a?(e.checked=a,a?t.classList.add("hidden"):t.classList.remove("hidden")):e.checked=t.classList.toggle("hidden")},d=e=>{i(u,f,e)},h=e=>{const t=document.querySelector(".activePlayer .fleetBoard");i(g,t,e)},m=document.getElementById("resetGame"),p=document.getElementById("computerPlay"),u=document.getElementById("hideLog"),g=document.getElementById("fleetToggle"),y=document.querySelector(".shipPlacementActions"),f=document.querySelector(".logContainer"),k=document.querySelector(".gameContainer"),v=e("Player One",t(10,10)),C=e("Player Two",t(10,10)),b=e("Computer",t(10,10),!0),E=((e,t,o)=>{const n={player:e,opponent:t,computer:o,gameInProgress:!1,shipPlacementDirection:"h"},l={keyboard:{},placementError:[],preReset:[],preShipPlacement:[],preShipsPlacement:[],postShipsPlacement:[],preAttack:[],postAttack:[],preGame:[],postGame:[]},c={};let s=e,i=t,d={},h=!1;window.addEventListener("keydown",(e=>{const t=l.keyboard[e.code];t&&t.forEach((e=>e.call(null)))}));const m=(e,t=[])=>{l[e]&&l[e].forEach((e=>e.apply(null,t)))},p=(e,t,a=!1)=>{const r=e.targetDisplay,o=e.fleetDisplay;let n=[r,o];a&&(n=[o]),t.forEach((e=>{const[t,a]=e;n.forEach((e=>{e.updateField(t,a,"pegTemplate","whitePeg")}))}))},u=(e,t)=>{e.computerPlayer||e.targetDisplay.clear(!0),m("postShipsPlacement",[e,t]),d.resolve()},g=(e,t)=>(d.ships.splice(0,e.gameboard.shipCount),d.ships.forEach((t=>{const a=e.randomShipPlacement(t);p(e,a,!0)})),u(e,t)),y=(a,o)=>{m("preShipsPlacement",[a,o]);const l=[2,3,3,4,5].map((e=>r(e))),c=a.targetDisplay;let s=[],i=0,h=l[i];const y=(e,t)=>{s=[],c.removeHighlights();for(let a=0;a<h.length;a++){let r="h"===n.shipPlacementDirection?[e,t+a]:[e+a,t];c.highlightField.apply(null,r),s.push(r)}};return m("preShipPlacement",[e,t,h]),new Promise((r=>{if(d={player:a,ships:l,resolve:r},a.computerPlayer)return g(a,o);c.addCallback("mouseover","showPlacement",y),c.addCallback("focusin","showPlacement",y),c.addCallback("click","placeShip",(()=>{try{if(a.gameboard.placeShip(s,h),p(a,s),h=l[++i],i>=l.length)return u(a,o);s=[],m("preShipPlacement",[e,t,h])}catch(e){m("placementError",[e]),console.error(e.message)}}))}))},f=(e,t,a)=>{const[r,o]=t;a&&e.updateField(r,o,"pegTemplate",a)};return n.addCallback=(e,...t)=>{t.forEach((t=>{l[t]&&l[t].push(e)}))},n.addKeyboardCallback=(e,t)=>{const a=l.keyboard[e];a?a.push(t):l.keyboard[e]=[t]},n.toggleComputer=()=>{h?([e,t]=[s,i],h=!1):([e,t]=[s,o],h=!0),[n.player,n.opponent]=[e,t]},n.resetGame=()=>(m("preReset",[e,t]),n.gameInProgress=!1,o&&o.reset(),[e,t].forEach((e=>{return(t=e).gameboard.clear(),void[t.targetDisplay,t.fleetDisplay].forEach((e=>{e.clear(!0)}));var t})),new Promise((async a=>{await y(e,t),await y(t,e),n.gameInProgress=!0,d={},a()}))),n.placeShipsRandomly=()=>{d.player&&g(d.player)},n.play=async()=>{if(!n.gameInProgress)return null;{m("preAttack",[e,t]);const a=await new Promise(((a,r)=>{if(e.computerPlayer)a(e.attack(t));else{const r=e.targetDisplay;(e=>{const t=c[e.name],a=e.container.querySelector(".targetBoard");t&&a&&a.querySelector(`[data-field="${t}"]`).focus()})(e),r.addCallback("click","userAttack",((o,n)=>{if(void 0===e.gameboard.targetBoard[[o,n]]){const l=e.attack(t,o,n);c[e.name]=`${o}${n}`,r.removeCallback("click","userAttack"),a({coordinates:[o,n],attackResult:l})}}))}}));if((a=>{const r=a.attackResult;if("object"==typeof r&&r.isSunk())o=a.coordinates,t.gameboard.shipPlacements.find((e=>e.find((e=>e.join()===o.join())))).forEach((t=>f(e.targetDisplay,t,"cyanPeg")));else{const t=r?"whitePeg":"redPeg";f(e.targetDisplay,a.coordinates,t)}var o;const n=r?"redPeg":null;f(t.fleetDisplay,a.coordinates,n)})(a),m("postAttack",[e,t,a]),t.gameboard.shipCount<=0)return n.gameInProgress=!1,m("postGame",[e,t]),e;[e,t]=[t,e],[n.player,n.opponent]=[n.opponent,n.player]}},n.playGame=async()=>await n.play()||n.playGame(),(()=>{const r=[e,t];o&&r.push(o),r.forEach((e=>{e.targetDisplay=a(10,10),e.fleetDisplay=a(10,10),e.container=(()=>{const e=document.createElement("div"),t=document.createElement("h2"),a=document.createElement("div"),r=document.createElement("h2"),o=document.createElement("div");return t.textContent="Target Board",r.textContent="Fleet Board",e.classList.add("playerContainer"),a.classList.add("targetBoard"),o.classList.add("fleetBoard"),[[t,a],[r,o]].forEach((t=>{const[a,r]=t;a.classList.add("boardHeader");const o=document.createElement("section");o.appendChild(a),o.appendChild(r),e.appendChild(o)})),e})(),e.targetDisplay.renderBoard(e.container.querySelector(".targetBoard")),e.fleetDisplay.renderBoard(e.container.querySelector(".fleetBoard"))}))})(),n})(v,C,b),P=((e="")=>{const t={},a=document.createElement("ul");a.classList.value=e;let r=0;return t.renderLog=(e=document.body)=>{e.appendChild(a)},t.addMessage=(e,t=!0,o="")=>{const n=document.createElement("li");n.textContent=`${t?++r+". ":""}${e}`,n.style.color=o,a.prepend(n)},t.clear=()=>{Array.from(a.children).forEach((e=>a.removeChild(e))),r=0},t})("gameLog");P.renderLog(f),E.addCallback(((e,t,a)=>{P.addMessage(`Now placing Ship of length: ${a.length}`)}),"preShipPlacement"),E.addCallback((e=>{P.addMessage(e.message,!1,"red")}),"placementError"),E.addCallback(((e,t)=>{n(e,t),h(!0),c("h"),y.classList.remove("hidden"),P.clear(),P.addMessage(`${e.name} please place your ships`,!1,o(e))}),"preShipsPlacement"),E.addCallback((()=>{h(!0),y.classList.add("hidden"),P.clear()}),"postShipsPlacement"),E.addCallback(((e,t)=>{n(e,t)}),"preAttack"),E.addCallback(((e,t,a)=>{const[r,n]=a.coordinates,l=a.attackResult,c=`${String.fromCharCode(65+r)}${n+1}`,s=l?"Hit":"Miss";if(P.addMessage(`Attack from ${e.name} at ${c} resulted in ${s}`,!0,o(e)),"object"==typeof l&&l.isSunk()){const a=t.gameboard.shipCount,r=`${e.name} has sunk ship of size ${l.length}.`,o=`${t.name} has ${a} remaining ships.`;P.addMessage(r,!1,"#00dada"),P.addMessage(o,!1,"#00dada")}e.computerPlayer||t.computerPlayer||h(!0)}),"postAttack"),E.addCallback(((e,t)=>{const a=`${e.name} has won the game!`;P.addMessage(a,!1),d(!0),n(e,t,a),g.checked=!1,k.querySelectorAll(".fleetBoard").forEach((e=>{e.classList.remove("hidden")})),k.insertBefore(e.container,t.container),e.container.scrollIntoView({behavior:"smooth"}),e.container.classList.add("winningPlayer"),t.container.classList.remove("hidden")}),"postGame"),y.addEventListener("click",(e=>{const t=e.target,a=t.dataset.direction;a&&(E.shipPlacementDirection=a,c(a)),"randomPlacement"===t.id&&E.placeShipsRandomly()})),m.addEventListener("click",l),p.addEventListener("change",s),u.addEventListener("change",d),g.addEventListener("change",h),E.addKeyboardCallback("KeyR",l),E.addKeyboardCallback("KeyC",(()=>{p.checked=!p.checked,s()})),E.addKeyboardCallback("KeyL",d),E.addKeyboardCallback("KeyF",h),E.addKeyboardCallback("KeyH",(()=>c("h"))),E.addKeyboardCallback("KeyV",(()=>c("v"))),l()})();